# Dockerfile for Salt Master
FROM ubuntu:22.04

SHELL ["/bin/bash", "-o", "pipefail", "-c"]

# Install dependencies
RUN apt-get update && apt-get install -y curl sudo build-essential

# Salt deps
RUN mkdir -p /etc/apt/keyrings
RUN curl -fsSL https://packages.broadcom.com/artifactory/api/security/keypair/SaltProjectKey/public | tee /etc/apt/keyrings/salt-archive-keyring.pgp
RUN curl -fsSL https://github.com/saltstack/salt-install-guide/releases/latest/download/salt.sources | tee /etc/apt/sources.list.d/salt.sources

# do we actually want to pin the version?
RUN sh -c "\
    echo 'Package: salt-*' > /etc/apt/preferences.d/salt-pin-1001 && \
    echo 'Pin: version 3006.*' >> /etc/apt/preferences.d/salt-pin-1001 && \
    echo 'Pin-Priority: 1001' >> /etc/apt/preferences.d/salt-pin-1001"

RUN apt-get update && \
    apt-get install -y --no-install-recommends salt-common=3006.9 \
    salt-master=3006.9 \
    salt-ssh=3006.9 \
    salt-syndic=3006.9 \
    salt-cloud=3006.9 \
    salt-api=3006.9 \
    libpam0g \
    python3-pam \
    && rm -rf /var/lib/apt/lists/*

# Set up salt-api user with proper permissions
RUN useradd -m -s /bin/bash saltapi && \
    echo "saltapi:saltapi" | chpasswd && \
    usermod -aG sudo saltapi

# Copy configuration files
COPY salt/master/master.conf /etc/salt/master
COPY salt/master/configs/api.conf /etc/salt/master.d/api.conf
COPY salt/master/configs/salt /etc/pam.d/salt

# Ensure proper permissions
RUN chmod 644 /etc/pam.d/salt && \
    chown root:root /etc/pam.d/salt

# Expose ports for event bus
EXPOSE 4505 4506 8000

HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD salt-run manage.status || exit 1

# Copy systemd service files
COPY salt/master/configs/systemd/salt-master.service /etc/systemd/system/
COPY salt/master/configs/systemd/salt-api.service /etc/systemd/system/

# Change CMD to start services
CMD salt-master 
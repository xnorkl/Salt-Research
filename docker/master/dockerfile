FROM ubuntu:22.04

SHELL ["/bin/bash", "-o", "pipefail", "-c"]

# Install dependencies
RUN apt-get update && apt-get install -y curl sudo build-essential supervisor

# Salt deps
RUN mkdir -p /etc/apt/keyrings
RUN curl -fsSL https://packages.broadcom.com/artifactory/api/security/keypair/SaltProjectKey/public | tee /etc/apt/keyrings/salt-archive-keyring.pgp
RUN curl -fsSL https://github.com/saltstack/salt-install-guide/releases/latest/download/salt.sources | tee /etc/apt/sources.list.d/salt.sources

# do we actually want to pin the version?
RUN sh -c "\
    echo 'Package: salt-*' > /etc/apt/preferences.d/salt-pin-1001 && \
    echo 'Pin: version 3006.*' >> /etc/apt/preferences.d/salt-pin-1001 && \
    echo 'Pin-Priority: 1001' >> /etc/apt/preferences.d/salt-pin-1001"

RUN apt-get update && \
    apt-get install -y --no-install-recommends salt-common=3006.9 \
    salt-master=3006.9 \
    salt-ssh=3006.9 \
    salt-syndic=3006.9 \
    salt-cloud=3006.9 \
    salt-api=3006.9 \
    python3-pip \
    python3-cherrypy3 \
    apache2-utils && \
    pip3 install azure-storage-file-share && \
    rm -rf /var/lib/apt/lists/*

# Create SSL certificates for salt-api
RUN mkdir -p /etc/pki/tls/certs && \
    mkdir -p /etc/pki/tls/private && \
    openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
    -keyout /etc/pki/tls/private/localhost.key \
    -out /etc/pki/tls/certs/localhost.crt \
    -subj "/C=US/ST=State/L=City/O=Organization/CN=localhost"

# Create salt-api user
RUN useradd -rs /bin/false saltapi && \
    echo "saltapi:password" | chpasswd

# Copy configuration files
COPY salt/master/master.conf /etc/salt/master
COPY salt/master/files/api.conf /etc/salt/master.d/api.conf

# Update CMD to start both salt-master and salt-api
COPY docker/master/supervisord.conf /etc/supervisor/conf.d/supervisord.conf

CMD ["/usr/bin/supervisord", "-n", "-c", "/etc/supervisor/conf.d/supervisord.conf"]

EXPOSE 4505 4506

HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD salt-run manage.status || exit 1

CMD ["salt-master", "-l", "debug"]